/* ═══════════════════════════════════════════════════
   LANDING MAP — Canvas world map with real coordinates
   Green wireframe on black, equirectangular projection
   ═══════════════════════════════════════════════════ */
const LandingMap = (() => {
  let canvas, ctx, W, H, animFrame = null, time = 0;

  function proj(lon, lat) {
    return [(lon + 180) / 360 * W, (90 - lat) / 180 * H];
  }

  // ── Closed polygons (continents & islands) ──────────
  const POLYS = [
    // North America
    [[-168,66],[-160,60],[-155,59],[-150,60],[-145,60],[-140,59],[-135,57],[-132,54],[-130,52],[-128,50],[-126,48],[-124,46],[-124,42],[-122,38],[-120,35],[-118,34],[-117,33],[-115,30],[-112,28],[-110,24],[-105,20],[-100,17],[-95,16],[-90,14],[-86,12],[-83,10],[-80,8],[-78,9],[-83,14],[-86,16],[-88,18],[-90,21],[-92,21],[-95,22],[-97,26],[-97,28],[-95,29],[-92,30],[-89,30],[-86,30],[-83,30],[-82,28],[-80,25],[-80,28],[-82,30],[-79,32],[-78,34],[-76,37],[-75,39],[-74,41],[-71,43],[-70,44],[-67,45],[-66,44],[-63,44],[-60,47],[-56,47],[-53,47],[-56,49],[-60,48],[-64,50],[-60,54],[-64,58],[-70,60],[-78,62],[-84,64],[-90,68],[-95,70],[-105,73],[-115,72],[-125,71],[-135,69],[-145,70],[-155,71],[-162,72],[-168,66]],
    // Greenland
    [[-52,60],[-48,61],[-44,62],[-40,64],[-35,68],[-28,70],[-22,73],[-20,76],[-22,78],[-30,80],[-40,82],[-50,81],[-55,78],[-58,74],[-56,70],[-52,66],[-48,62],[-52,60]],
    // South America
    [[-77,8],[-75,5],[-77,2],[-80,0],[-80,-3],[-78,-6],[-75,-10],[-72,-14],[-68,-17],[-64,-20],[-58,-24],[-52,-23],[-48,-18],[-45,-13],[-42,-8],[-40,-3],[-37,-3],[-35,-6],[-35,-10],[-38,-14],[-42,-20],[-45,-23],[-48,-28],[-52,-32],[-56,-35],[-60,-38],[-64,-42],[-68,-48],[-68,-52],[-70,-54],[-73,-50],[-74,-45],[-72,-42],[-72,-38],[-73,-33],[-75,-25],[-77,-15],[-79,-8],[-80,-2],[-80,0],[-78,3],[-77,6],[-77,8]],
    // Africa
    [[-17,15],[-17,12],[-15,11],[-12,8],[-8,5],[-4,5],[0,5],[3,6],[5,4],[8,4],[10,4],[10,1],[10,-2],[12,-6],[14,-10],[16,-14],[18,-20],[20,-24],[22,-28],[25,-30],[28,-34],[30,-34],[34,-28],[36,-22],[40,-16],[42,-10],[44,-4],[46,0],[48,4],[50,8],[50,12],[48,12],[45,12],[43,12],[42,14],[38,20],[35,24],[33,28],[32,31],[28,33],[25,31],[20,33],[15,36],[10,37],[5,36],[0,36],[-5,36],[-8,35],[-12,30],[-15,24],[-17,20],[-17,15]],
    // Europe
    [[-10,36],[-10,40],[-9,42],[-8,44],[-4,44],[-1,44],[0,43],[3,43],[1,47],[-4,48],[-2,49],[2,51],[5,52],[7,54],[10,55],[10,57],[9,58],[12,56],[13,58],[12,60],[14,63],[14,66],[16,69],[20,70],[25,71],[30,70],[40,68],[38,60],[34,55],[30,52],[26,48],[22,44],[25,40],[28,37],[26,35],[24,36],[22,38],[20,40],[18,42],[15,45],[13,44],[13,42],[16,40],[16,38],[14,37],[12,37],[10,39],[8,44],[6,43],[3,43],[0,42],[-3,37],[-5,37],[-8,37],[-10,36]],
    // UK
    [[-6,50],[-5,52],[-4,54],[-3,55],[-5,57],[-6,58],[-3,58],[-2,57],[0,53],[1,52],[0,51],[-1,51],[-4,50],[-6,50]],
    // Ireland
    [[-10,52],[-10,54],[-8,55],[-6,55],[-6,53],[-8,52],[-10,52]],
    // Iceland
    [[-24,64],[-22,65],[-18,66],[-14,66],[-13,65],[-18,63],[-22,63],[-24,64]],
    // Arabian Peninsula
    [[36,28],[38,24],[40,20],[43,16],[45,13],[48,14],[50,16],[52,20],[55,23],[56,25],[56,27],[52,25],[50,27],[50,30],[47,30],[44,30],[42,32],[38,32],[36,30],[36,28]],
    // Japan Honshu
    [[130,31],[131,33],[133,34],[135,35],[137,36],[140,38],[141,40],[141,42],[143,43],[145,44],[145,42],[143,40],[141,38],[140,36],[139,34],[137,33],[135,33],[132,32],[130,31]],
    // Japan Hokkaido
    [[140,42],[141,43],[143,44],[146,44],[145,43],[143,42],[141,41],[140,42]],
    // Korea
    [[126,34],[127,36],[128,37],[129,38],[130,38],[129,36],[128,35],[127,34],[126,34]],
    // Taiwan
    [[120,22],[121,23],[122,25],[121,25],[120,24],[120,22]],
    // Philippines
    [[120,18],[122,17],[124,14],[126,11],[126,9],[124,7],[122,8],[120,10],[118,12],[119,14],[120,16],[120,18]],
    // Borneo
    [[109,1],[111,2],[114,4],[117,5],[118,6],[118,4],[117,2],[116,0],[115,-2],[113,-3],[111,-2],[109,0],[109,1]],
    // Sumatra
    [[95,5],[97,3],[100,0],[103,-1],[105,-5],[106,-6],[104,-6],[101,-3],[98,0],[95,5]],
    // Java
    [[106,-6],[108,-7],[111,-7],[114,-8],[115,-8],[113,-7],[110,-6],[107,-6],[106,-6]],
    // Sulawesi
    [[120,1],[121,0],[122,-2],[123,-4],[122,-5],[121,-3],[120,-1],[119,0],[120,1]],
    // Papua New Guinea
    [[141,-2],[144,-4],[147,-5],[150,-7],[152,-6],[155,-6],[154,-4],[151,-2],[148,-1],[145,0],[142,0],[141,-2]],
    // Australia
    [[115,-35],[118,-35],[121,-33],[125,-30],[129,-25],[132,-18],[135,-13],[138,-12],[141,-13],[144,-15],[147,-19],[150,-24],[152,-28],[153,-31],[153,-34],[150,-36],[148,-38],[146,-39],[143,-38],[140,-35],[138,-34],[137,-35],[135,-34],[132,-31],[128,-26],[124,-23],[120,-20],[118,-22],[116,-24],[114,-27],[114,-32],[115,-35]],
    // Tasmania
    [[145,-40],[147,-41],[148,-43],[146,-44],[145,-43],[144,-42],[145,-40]],
    // NZ North
    [[172,-34],[174,-36],[176,-37],[178,-38],[177,-40],[175,-41],[174,-40],[173,-38],[172,-34]],
    // NZ South
    [[167,-44],[169,-43],[171,-42],[172,-44],[170,-46],[168,-47],[167,-46],[167,-44]],
    // Madagascar
    [[44,-12],[46,-14],[48,-16],[50,-18],[50,-22],[48,-24],[46,-25],[44,-24],[44,-20],[43,-16],[44,-12]],
    // Sri Lanka
    [[80,8],[81,7],[82,7],[82,6],[80,6],[80,8]],
    // Cuba
    [[-85,22],[-82,23],[-80,23],[-78,22],[-76,20],[-78,20],[-82,21],[-85,22]],
  ];

  // ── Open coastline paths (not closed) ──────────────
  const COASTS = [
    // Russia Arctic coast
    [[40,68],[50,68],[55,70],[60,72],[70,72],[80,72],[90,74],[100,73],[110,72],[120,70],[130,66],[135,62],[140,58],[145,52],[150,52],[155,58],[160,60],[163,65],[170,64],[180,65]],
    // Russia Pacific coast (Kamchatka → Vladivostok)
    [[163,65],[160,55],[155,50],[150,46],[145,45],[142,44],[140,43],[137,40],[135,38],[132,43]],
    // East Asian coast (Russia → China → Vietnam → Singapore)
    [[132,43],[130,40],[128,38],[126,35],[124,34],[122,32],[121,30],[120,28],[118,25],[116,23],[114,22],[112,20],[110,18],[108,16],[106,12],[105,10],[104,5],[103,2],[104,1]],
    // South Asian coast (Pakistan → India → Myanmar → Singapore)
    [[66,25],[68,23],[70,21],[72,18],[73,15],[75,12],[77,8],[78,8],[80,10],[80,13],[82,16],[84,19],[86,21],[88,22],[90,22],[92,19],[94,16],[96,14],[98,10],[100,6],[101,4],[103,2],[104,1]],
    // Turkey south → Levant
    [[30,37],[32,37],[34,36],[36,37],[36,34],[35,32],[34,30],[33,28]],
    // Persian Gulf / Iran south coast
    [[50,30],[50,27],[52,25],[55,23],[57,25],[60,25],[62,25],[66,25]],
    // Russia south / Central Asia
    [[30,52],[35,48],[40,44],[45,42],[50,40],[55,42],[60,44],[65,45],[70,48],[75,50],[80,50],[85,48],[90,50],[95,52],[100,52],[105,53],[110,50],[115,48],[120,50],[125,45],[130,42],[132,43]],
  ];

  // ── Internal borders ────────────────────────────────
  const BORDERS = [
    [[-130,49],[-120,49],[-110,49],[-100,49],[-95,49],[-90,48],[-85,46],[-80,44],[-75,45],[-67,47]],
    [[-117,33],[-112,31],[-108,31],[-105,29],[-100,26],[-97,26]],
    [[-17,24],[-10,24],[0,24],[10,24],[20,24],[30,24]],
    [[10,4],[10,0],[15,-5],[25,-5],[30,-5]],
    [[30,0],[30,-10],[30,-15],[35,-20]],
    [[30,10],[35,10],[42,10]],
    [[5,46],[10,46],[15,46],[20,46],[25,46]],
    [[10,52],[15,52],[20,52],[25,52],[30,52]],
    [[15,46],[15,50],[15,54]],
    [[25,48],[25,42],[25,36]],
    [[80,45],[90,48],[100,50],[110,48],[120,48],[130,45]],
    [[68,24],[75,30],[80,35],[85,28],[90,28]],
    [[-60,-3],[-55,-10],[-50,-15],[-45,-20]],
    [[-70,-18],[-70,-25],[-70,-35],[-70,-45],[-70,-50]],
    [[-5,10],[0,10],[5,10],[10,10]],
    [[-10,15],[0,15],[10,15],[15,15]],
    [[35,33],[40,33],[45,33],[48,33]],
    [[42,37],[48,37],[52,37]],
    [[129,-26],[138,-26],[145,-26]],
    [[138,-12],[138,-26],[138,-38]],
    [[-5,15],[-5,10],[-5,5]],
    [[20,-5],[20,-15],[20,-25]],
    [[10,37],[10,30],[10,24],[10,15],[10,10],[10,4]],
  ];

  // ── Animated city dots ──────────────────────────────
  const CITIES = [
    {lon:-74,lat:40.7,p:0},{lon:0,lat:51.5,p:1},{lon:139.7,lat:35.7,p:.5},
    {lon:116.4,lat:39.9,p:1.5},{lon:-46.6,lat:-23.6,p:.8},{lon:31.2,lat:30,p:1.8},
    {lon:72.9,lat:19.1,p:2.3},{lon:151.2,lat:-33.9,p:2},{lon:37.6,lat:55.8,p:1.2},
    {lon:-99.1,lat:19.4,p:.3},{lon:121,lat:14.6,p:1.6},{lon:-122.4,lat:37.8,p:2.5},
    {lon:55.3,lat:25.3,p:.7},{lon:28,lat:-26,p:1.9},{lon:2.3,lat:48.9,p:.4},
  ];

  function init(el) {
    if (!el) return;
    canvas = el;
    ctx = canvas.getContext('2d');
    resize();
    window.addEventListener('resize', resize);
    draw();
  }

  function resize() {
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.parentElement.getBoundingClientRect();
    W = rect.width;
    H = rect.height;
    canvas.width = W * dpr;
    canvas.height = H * dpr;
    canvas.style.width = W + 'px';
    canvas.style.height = H + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  function drawPath(pts, close) {
    if (pts.length < 2) return;
    ctx.beginPath();
    const [sx, sy] = proj(pts[0][0], pts[0][1]);
    ctx.moveTo(sx, sy);
    for (let i = 1; i < pts.length; i++) {
      const [px, py] = proj(pts[i][0], pts[i][1]);
      ctx.lineTo(px, py);
    }
    if (close) ctx.closePath();
    ctx.stroke();
  }

  function draw() {
    if (!W || !H) return;
    const landing = document.getElementById('landing');
    if (!landing || landing.classList.contains('hidden')) return;

    ctx.clearRect(0, 0, W, H);

    // ── Grid lines ──
    ctx.strokeStyle = 'rgba(0,255,65,0.03)';
    ctx.lineWidth = 0.5;
    for (let lon = -180; lon <= 180; lon += 30) {
      const [x] = proj(lon, 0);
      ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
    }
    for (let lat = -80; lat <= 80; lat += 20) {
      const [, y] = proj(0, lat);
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
    }

    // ── Coastline polygons ──
    ctx.save();
    ctx.shadowColor = 'rgba(0,255,65,0.3)';
    ctx.shadowBlur = 3;
    ctx.strokeStyle = 'rgba(0,255,65,0.28)';
    ctx.lineWidth = 0.9;
    ctx.lineJoin = 'round';
    POLYS.forEach(p => drawPath(p, true));

    // ── Open coastline paths ──
    ctx.strokeStyle = 'rgba(0,255,65,0.25)';
    ctx.lineWidth = 0.8;
    COASTS.forEach(p => drawPath(p, false));

    // ── Internal borders ──
    ctx.shadowBlur = 1;
    ctx.strokeStyle = 'rgba(0,255,65,0.15)';
    ctx.lineWidth = 0.4;
    BORDERS.forEach(p => drawPath(p, false));
    ctx.restore();

    // ── Pulsing city dots ──
    time += 0.02;
    CITIES.forEach(c => {
      const [x, y] = proj(c.lon, c.lat);
      const pulse = (Math.sin(time * 2 + c.p * Math.PI) + 1) / 2;
      const r = 1.5 + pulse * 2.5;
      const a = 0.08 + pulse * 0.3;
      ctx.fillStyle = `rgba(0,255,65,${a})`;
      ctx.beginPath();
      ctx.arc(x, y, r, 0, Math.PI * 2);
      ctx.fill();
    });

    animFrame = requestAnimationFrame(draw);
  }

  function stop() {
    if (animFrame) { cancelAnimationFrame(animFrame); animFrame = null; }
  }

  return { init, stop };
})();
